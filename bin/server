#!/usr/bin/env node
'use strict';

var http = require('http');
var path = require('path');
var url = require('url');
var fs = require('fs');
//var S = require('string');
//var async = require('async');
var _ = require('lodash');
var soap = require('soap');

// mock data generated by mockaroo.com
var products = require('../data/products.json');
var productsById = {};
_.each(products, function(p) { productsById[p.id] = p; });

var soapPort = process.env.SOAP_PORT || 3000;
var soapBaseAddress = process.env.SOAP_BASE_ADDRESS || 'http://0.0.0.0:' + soapPort;
var timeout = process.env.TIMEOUT || 20 * 60 * 1000; // 20 mins
var responseDelay = process.env.RESPONSE_DELAY || 10 * 1000; // 10 seconds

var rawWsdl = fs.readFileSync(path.resolve(__dirname, '..', 'services.wsdl'), 'utf8');
var wsdl = rawWsdl.replace(/{{baseAddress}}/g, soapBaseAddress);



var toSoapError = function(err) {
  console.error(err);

  return {
    Fault: {
      Code: {
        Value: "soap:Sender"
        //, Subcode: { value: "soap:Error" }
      },
      Reason: { Text: err.soapText || err.message || err.toString() }
    }
  };
};



// prepare SOAP server
var server = http.createServer(function(req, res) {
  var parsedUrl = url.parse(req.url);

  if (parsedUrl.pathname === '/') {
    res.writeHead(200, { 'Content-Type': 'application/xml' });

    var tailoredWsdl = wsdl;

    if (!process.env.SOAP_BASE_ADDRESS) {
      tailoredWsdl = rawWsdl.replace(/{{baseAddress}}/g, 'http://' + req.headers.host);
    }

    res.write(tailoredWsdl);
  } else {
    res.writeHead(404, { 'Content-Type': 'text/plain' });

    res.write('Not Found: ' + req.url);
  }

  res.end();
});

server.setTimeout(timeout);
server.log = console.log;
server.on('error', function(err) {
  if (err) throw err;
});



// register SOAP endpoints for inventory service
var checkAvailability = function(input, callback) {
  if (!input.product || !input.product.id) return callback(new Error('product ID missing'));

  if (!productsById[input.product.id]) return callback(new Error('product missing'));

  var output = {
    status: {},
    product: _.clone(productsById[input.product.id])
  };

  if (output.product.available) output.status.currentAvailability = 'available';
  else output.status.currentAvailability = 'not available';

  output.status.availableAgainInDays = output.product.days;

  delete output.product.available;
  delete output.product.days;

  setTimeout(function() {
    callback(null, output);
  }, responseDelay);
};

var inventoryPort = { InventoryService: {} };

inventoryPort.InventoryService.InventoryPort = {
  checkAvailability: function(input, callback, headers) {
    input = input || {};

    checkAvailability(input, function(err, output) {
      if (err) throw toSoapError(err);

      callback(output);
    });
  },
  checkAvailabilityAsync: function(input, callback, headers) {
    input = input || {};

    if (!input.callbackUrl) throw toSoapError(new Error('callback URL missing'));

    checkAvailability(input, function(err, output) {
      if (err) return console.error(err);

      output = {
        customerId: input.customerId,
        status: output.status,
        product: output.product
      };

      soap.createClient(input.callbackUrl + '?wsdl', function(err, client) {
        if (err) return console.error(err);

        client.onFinishCheckAvailability(output, function(err, result) {
          if (err) return console.error(err);
        });
      });
    });

    //callback({ checkAvailabilityAsyncResponse: { estimatedDurationInMillis: responseDelay + _.random(1, 99) } });
    callback();
  },
  listProducts: function(input, callback, headers) {
    input = input || {};

    if (input.limit) input.limit = parseInt(input.limit);

    var count = 0;

    var output = { list: { product: [] } };

    _.each(products, function(p) {
      if (_.isNumber(input.limit) && input.limit <= count) return;

      p = _.clone(p);

      delete p.available;
      delete p.days;

      output.list.product.push(p);

      count++;
    });

    callback(output);
  }
};

soap.listen(server, '/InventoryService/InventoryPort', inventoryPort, wsdl);



// init SOAP server
server.listen(soapPort, function(err) {
  if (err) throw err;
});

console.log('server listening on port ' + soapPort);
